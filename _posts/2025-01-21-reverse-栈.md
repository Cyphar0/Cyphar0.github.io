---
layout: post
title: "栈"
category: reverse
date: 2025-01-22
---

在典型的内存布局中，**栈从高地址向低地址增长**，而**堆从低地址向高地址增长**

如果栈无限制地向下扩展，最终会触碰到堆

系统可以通过**检测栈指针（SP）和堆指针（HP）的相对位置**来发现两者是否已经接近或发生碰撞，从而及时触发异常（如栈溢出错误）



栈上的变量通常是**局部变量**或**函数参数**，只能通过该函数的代码或子函数

栈变量的生命周期与它所在的函数直接绑定：函数开始执行时，栈空间为该函数分配变量；当函数返回时，栈帧被销毁，栈变量也随之失效

栈的优点是方便存储管理，CPU 非常有效地管理和组织栈内存，不必手动分配内存或手动释放内存，并且速度非常快



- **栈指针（SP）**：指向当前栈顶的位置
- **帧指针（BP/FP）**：指向当前函数的栈帧基地址

![](E:\Git\Cyphar0\assets\images\栈\1.jpg)

当我们编译并运行这个程序时， 5 会被打印出来，如下所示：

![img](E:\Git\Cyphar0\assets\images\栈\2.jpg)

### 分析代码栈变化

#### **初始状态（`main`开始执行前）**

栈顶可能包含系统相关信息（如命令行参数）。

```c
|---------------| High Address
|    OS info    |  (e.g., argc, argv)
|---------------| <-- SP (栈指针)
```

#### **Step 1: `main`函数执行，建立`main`栈帧**

- 保存返回地址（`main`结束后返回到程序入口处）。
- 分配`main`的局部变量（`result`）。

```c
|---------------| High Address
|    OS info    |
| Return Addr   |  (to program entry)
|---------------| <-- BP (帧指针，指向main栈帧基址)
| result (4B)   |  (局部变量)
|---------------| <-- SP
```

#### **Step 2: 调用`addMe(2, 3)`**

1. **参数压栈**：将`2`和`3`作为参数从右向左压栈（约定的调用约定，如x86-64 ABI）。

   ​	从右向左压栈：addMe(2, 3)，3被先压入栈中，2后被压入栈中

2. **保存返回地址**：记录调用完成后返回到`main`函数的下一条指令。

3. **跳转到`addMe`函数**：建立`addMe`的栈帧。

```c
|---------------| High Address
|    OS info    |
| Return Addr   |  (to program entry)
|---------------| <-- BP (main帧基址)
| result (4B)   |
|---------------| <-- SP
| Return Addr   |  (to main after addMe)
| arg b = 3     |  (参数)
| arg a = 2     |  (参数)
|---------------|
|  (addMe栈帧) |
|---------------|
```

#### **Step 3: `addMe`函数执行**

- 保存调用者的`BP`，建立`addMe`函数的`BP`。
- 分配局部变量（`a`、`b`已经作为参数存在，不需要额外分配）。

```c
|---------------| High Address
|    OS info    |
| Return Addr   |  (to program entry)
|---------------| <-- BP (main帧基址)
| result (4B)   |
|---------------|
| Return Addr   |  (to main after addMe)
| arg b = 3     |
| arg a = 2     |
|---------------| <-- BP (addMe帧基址)
| (无局部变量)  |  (未额外分配局部变量)
|---------------| <-- SP
```

#### **Step 4: `addMe`返回**

1. 将返回值放入寄存器（如`EAX`或`RAX`）。
2. 弹出当前栈帧，恢复调用者的`BP`。
3. 跳转到保存的返回地址，继续执行`main`函数。

```c
|---------------| High Address
|    OS info    |
| Return Addr   |  (to program entry)
|---------------| <-- BP (main帧基址)
| result (4B)   |
|---------------| <-- SP
```

#### **Step 5: `main`函数结束**

- 输出结果。
- 恢复调用者栈帧，程序退出。

```c
|---------------| High Address
|    OS info    |
|---------------| <-- SP
```

------

### 栈变化图示

```c
Initial:         After `main`:        After `addMe(2, 3)`:    After `addMe` return:
|---------------| |---------------|  |---------------|      |---------------|
|   OS Info     | |   OS Info     |  |   OS Info     |      |   OS Info     |
|---------------| | Return Addr   |  | Return Addr   |      | Return Addr   |
|               | |---------------|  |---------------|      |---------------|
|               | | result (4B)   |  | result (4B)   |      | result (4B)   |
|---------------| |---------------|  |---------------|      |---------------|
                  |               |  | Return Addr   |      |               |
                  |               |  | arg b = 3     |      |               |
                  |               |  | arg a = 2     |      |               |
                  |               |  |---------------|      |               |
```

### 
